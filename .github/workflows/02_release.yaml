name: 02 release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - '.github/workflows'
  workflow_dispatch:

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@755da8c3cf115ac066823e79a1e1788f8940201b #v3.2.0
        with:
          fetch-depth: 0
      - uses: actions/setup-java@c3ac5dd0ed8db40fedb61c32fbe677e6b355e94c #v3.8.0
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'
          server-id: github
          settings-path: ${{ github.workspace }}

      - name: Create settings.xml
        uses: whelk-io/maven-settings-xml-action@7c60eb95b2d5ec18f2e0e29f34c9ed69475e7a96 #v21
        with:
          repositories: '[{ "id": "github", "name": "github", "url": "https://maven.pkg.github.com/navikt/xerces-xmlschema-1.1", "releases": { "enabled": "true" }, "snapshots": { "enabled": "false" } }]'
          servers: '[{ "id": "github", "username": "${{ github.actor }}", "password": "${{ secrets.GITHUB_TOKEN }}" }]'

      - name: Configure git user
        run: |
          git config user.name "GitHub Actions Bot (${{ github.actor }})"
          git config user.email "actions@github.com"

      - name: Publish
        run: |
          mvn --batch-mode deploy -DskipTests
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Report success?
        if: success()
        env:
          SLACK_CHANNEL: eresept
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_USERNAME: "release xerces-xmlschema-1.1"
          SLACK_TITLE: "Successfully released _*xerces-xmlschema-1.1*_"
          SLACK_MESSAGE: " "
          SLACK_COLOR: "good"
          SLACK_ICON: https://github.com/github.png?size=48
          MSG_MINIMAL: true
          SLACK_FOOTER: "eresept © 2022"
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 #v2
      - name: Report failure?
        if: failure()
        env:
          SLACK_CHANNEL: eresept
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_USERNAME: "release xerces-xmlschema-1.1"
          SLACK_TITLE: "Release of _*xerces-xmlschema-1.1*_ failed"
          SLACK_COLOR: "danger"
          SLACK_ICON: https://github.com/github.png?size=48
          SLACK_MESSAGE: "See https://github.com/${{ github.repository }}/actions/run/${{ github.run_id }} for details"
          SLACK_FOOTER: "eresept © 2022"
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 #v2
      - name: Report cancellation?
        if: cancelled()
        env:
          SLACK_CHANNEL: eresept
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_USERNAME: "release xerces-xmlschema-1.1"
          SLACK_TITLE: "Release of _*xerces-xmlschema-1.1*_ was cancelled"
          SLACK_MESSAGE: " "
          SLACK_COLOR: "warning"
          SLACK_ICON: https://github.com/github.png?size=48
          MSG_MINIMAL: true
          SLACK_FOOTER: "eresept © 2022"
        uses: rtCamp/action-slack-notify@12e36fc18b0689399306c2e0b3e0f2978b7f1ee7 #v2
